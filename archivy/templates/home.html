{% extends "base.html" %}
{% block content %}

{% if search_enabled %}
	<input type="text" id="searchBar">
	<ul id="searchHits">
	{% if lunr %}
  		<script src="https://unpkg.com/lunr/lunr.min.js"></script>
	{% endif %}
{% endif %}
	
</ul>

<a href="/bookmarks/new">New Bookmark</a>
<a href="/notes/new">New Note</a>
<br>
<a href="/plugins">Plugins</a>

{% set path = [] %}
{% set i = namespace(value=0) %}
{{ draw_dir(dataobjs, 0, 1) }}

{% if elasticsearch %}
  {% include "markdown-parser.html" %}
{% endif %}
<script>
  // search functionality
  {% if search_enabled %}  
    async function createHit(hit) {
      let hitsDiv = document.getElementById("searchHits");
      let hitLi = document.createElement("li");
	  {% if elasticsearch %}
      	let body = document.createElement("div");
        if ("highlight" in hit)
        {
          for(let i = 0; i < hit["highlight"].length; i++)
          {
            body.innerHTML += "\n" + window.parser.render(hit["highlight"][i]);  
          }
        }
        let p = document.createElement("p"), a = document.createElement("a"), hitText = '';
        p.innerHTML = hitText, a.textContent = hit["title"], a.href = `/dataobj/${hit['id']}`;
        hitLi.append(a);
        hitLi.append(p);
        hitLi.append(body);
	  {% elif lunr %}
		let data = await fetch(`${SCRIPT_ROOT}/dataobjs/${hit["ref"]}`);
		if (data.ok) {
		  let title = document.createElement("a");
		  title.href = `/dataobjs/${hit["ref"]}`;
		  let hitData = await data.json();
		  title.textContent = hitData["title"];
		  hitLi.append(title);
		}
	  {% endif %}
	  return hitLi;
    }
    {% if lunr %}
	  window.index = undefined;
	  async function loadLunrIndex() {
		if (!window.index) {
	      let loadIndex = await fetch(`${SCRIPT_ROOT}/search_index`, {
	        "method": "GET"
	      });
	      if (loadIndex.ok) {
			  let body = await loadIndex.text()
	  		 window.index = lunr.Index.load(JSON.parse(body));
	      }
		}
	  }
	{% endif %}

    let input = document.getElementById("searchBar");
    input.addEventListener('input', async function(e) {
	  let searchHitsContainer = document.getElementById("searchHits");
      if (input.value !== "")
      {
		let searchResults;
		{% if elasticsearch %}
          let searchQuery = await fetch(`${SCRIPT_ROOT}/search?query=${input.value}`, {
            "method": "GET"
          });
          if (searchQuery.ok) {  
			searchResults = await searchQuery.json(), i = 0;
          }
		{% elif lunr %}
		  await loadLunrIndex();
		  searchResults = await window.index.search(input.value);
		  // TODO: optimize this
		  // lunr doesn't return the fields in the result: https://github.com/olivernn/lunr.js/issues/88
		  // return fifth first results
		{% endif %}
		// need to gather html hits and THEN add them because latency between async 'input' events can cause errors in output
		// if results are not cleared right before adding new hits.
		let htmlHits = await Promise.all(searchResults.slice(0, 5).map(async (hit) => await createHit(hit)))
	    searchHitsContainer.textContent = "";
		htmlHits.forEach((hit) => searchHitsContainer.appendChild(hit));
     }
    });
  {% endif %}	
</script>
{% endblock %}
